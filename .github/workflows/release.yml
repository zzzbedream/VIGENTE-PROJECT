name: Build and Release (SEP-0055)

on:
  push:
    # 1Ô∏è‚É£ Se activa autom√°ticamente al subir un tag (ej: v1.0.1)
    tags:
      - "v*"
  
  # 2Ô∏è‚É£ O permite dispararlo manualmente desde la pesta√±a Actions
  workflow_dispatch:
    inputs:
      release_name:
        description: "Release Version (e.g. v1.0.0)"
        required: true
        type: string

# üîê PERMISOS CR√çTICOS (Requeridos por SEP-0055)
permissions:
  id-token: write
  contents: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Rust
        run: |
          rustup update
          rustup target add wasm32-unknown-unknown

      # 3Ô∏è‚É£ Configurar Variables de Entorno (Ajustado para MONOREPO)
      - name: Set up env vars
        run: |
          # Ruta dentro de tu monorepo
          echo "WASM_FILE=contracts/target/wasm32-unknown-unknown/release/pyme_token_v1.wasm" >> $GITHUB_ENV
          
          if [ -n "${{ github.event.inputs.release_name }}" ]; then
            echo "TAG_NAME=${{ github.event.inputs.release_name }}" >> $GITHUB_ENV
          else
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      # 4Ô∏è‚É£ Instalar Stellar CLI
      - uses: stellar/stellar-cli@v22.8.1
        with:
          version: 22.8.1

      # 5Ô∏è‚É£ Compilar e Inyectar Metadatos (Coraz√≥n del SEP-0055)
      - name: Build and Optimize contract
        run: |
          cd contracts
          
          # Inyectamos metadatos en el binario
          stellar contract build \
            --package pyme_token_v1 \
            --meta home_domain=vigente.lat \
            --meta source_repo=github:${{ github.repository }}
          
          # Optimizamos el binario para producci√≥n
          stellar contract optimize --wasm target/wasm32-unknown-unknown/release/pyme_token_v1.wasm
          
          cd ..

      # 6Ô∏è‚É£ Subir artefacto temporal
      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pyme_token_v1.wasm
          path: ${{ env.WASM_FILE }}

      # 7Ô∏è‚É£ Generar la Attestation (La Firma Criptogr√°fica de GitHub)
      - name: Build Attestation for Release
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: pyme_token_v1.wasm
          subject-path: ${{ env.WASM_FILE }}

      # 8Ô∏è‚É£ Crear Release en GitHub
      - name: Make a new Release
        id: release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ env.TAG_NAME }}',
              target_commitish: '${{ github.sha }}',
              make_latest: 'true'
            });
            const { data } = response;
            core.setOutput('release_id', data.id);

      # 9Ô∏è‚É£ Subir el WASM compilado al Release
      - name: Upload to Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: '${{ steps.release.outputs.release_id }}',
              name: path.basename('${{ env.WASM_FILE }}'),
              data: fs.readFileSync('${{ env.WASM_FILE }}'),
            });
