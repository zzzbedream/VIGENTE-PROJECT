name: Build and Release (SEP-0055)

on:
  push:
    # 1Ô∏è‚É£ Se activa autom√°ticamente al subir un tag (ej: v1.0.1)
    tags:
      - "v*"
  
  # 2Ô∏è‚É£ O permite dispararlo manualmente desde la pesta√±a Actions
  workflow_dispatch:
    inputs:
      release_name:
        description: "Release Version (e.g. v1.0.0)"
        required: true
        type: string

# üîê PERMISOS CR√çTICOS (Requeridos por SEP-0055)
permissions:
  id-token: write
  contents: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Rust
        run: |
          rustup update
          rustup target add wasm32-unknown-unknown
          rustup target add wasm32v1-none

      # 3Ô∏è‚É£ Configurar Variables de Entorno
      - name: Set up env vars
        run: |
          echo "WASM_FILE=contracts/target/wasm32v1-none/release/pyme_token_v1.wasm" >> $GITHUB_ENV
          echo "RELEASES_REPO=zzzbedream/VIGENTE-RELEASES" >> $GITHUB_ENV
          
          if [ -n "${{ github.event.inputs.release_name }}" ]; then
            echo "TAG_NAME=${{ github.event.inputs.release_name }}" >> $GITHUB_ENV
          else
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      # 4Ô∏è‚É£ Instalar Stellar CLI
      - uses: stellar/stellar-cli@v22.8.1
        with:
          version: 22.8.1

      # 5Ô∏è‚É£ Compilar e Inyectar Metadatos (Coraz√≥n del SEP-0055)
      - name: Build and Optimize contract
        run: |
          cd contracts
          
          # Inyectamos metadatos en el binario
          stellar contract build \
            --package pyme_token_v1 \
            --meta home_domain=vigente.lat \
            --meta source_repo=github:zzzbedream/VIGENTE-RELEASES
          
          # Optimizamos el binario para producci√≥n
          stellar contract optimize --wasm target/wasm32v1-none/release/pyme_token_v1.wasm
          
          cd ..

      # 6Ô∏è‚É£ Subir artefacto temporal (para debugging)
      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pyme_token_v1.wasm
          path: ${{ env.WASM_FILE }}

      # 7Ô∏è‚É£ Crear Release en VIGENTE-RELEASES (repo p√∫blico)
      - name: Create Release in Public Repo
        id: release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RELEASES_TOKEN }}
          script: |
            const response = await github.rest.repos.createRelease({
              owner: 'zzzbedream',
              repo: 'VIGENTE-RELEASES',
              tag_name: '${{ env.TAG_NAME }}',
              name: 'VIGENTE Smart Contract ${{ env.TAG_NAME }}',
              body: `## üöÄ Release ${{ env.TAG_NAME }}\n\n**Build Info:**\n- Compiled with Stellar CLI v22.8.1\n- SEP-0055 Compliant\n- Source commit: ${{ github.sha }}\n\n**Verification:**\nThis release includes GitHub attestation for build provenance.`,
              make_latest: 'true'
            });
            core.setOutput('release_id', response.data.id);

      # 8Ô∏è‚É£ Subir el WASM al Release p√∫blico
      - name: Upload WASM to Public Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RELEASES_TOKEN }}
          script: |
            const fs = require('fs');
            await github.rest.repos.uploadReleaseAsset({
              owner: 'zzzbedream',
              repo: 'VIGENTE-RELEASES',
              release_id: ${{ steps.release.outputs.release_id }},
              name: 'pyme_token_v1.wasm',
              data: fs.readFileSync('${{ env.WASM_FILE }}'),
            });

      # 9Ô∏è‚É£ Generar Attestation (vinculada al repo p√∫blico)
      - name: Build Attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/zzzbedream/vigente-releases/pyme_token_v1.wasm
          subject-path: ${{ env.WASM_FILE }}
          push-to-registry: false
